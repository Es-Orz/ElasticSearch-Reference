# 读取和写入文档

Elasticsearch中的每个索引都被[分成分片（shards）](https://www.elastic.co/guide/en/elasticsearch/reference/5.4/gs-basic-concepts.html#getting-started-shards-and-replicas) ，每个分片可以有多个副本（copy/replicas）。这些复制被称为复制组(replication group)，并且在添加或删除文档时必须保持同步。如果我们不这样做，将导致从一个复制分片读的取结果比另一个分片读取的会不同的。保持分片复制同步并从中读取数据的过程就是我们所说的**数据复制模型**。

Elasticsearch的数据复制模型基于主备份(primary-backup,也叫master/slave)模型，在微软研究院的[PacificA论文]()中有很好的描述 。该模型基于具有充当主分片（primary-shard）的复制组的单个副本，其他复制称为复制分片。主分片主要作为所有建立索引操作的主要入口点。它负责验证它们并确保它们是正确的。一旦主服务器接受了索引操作，主服务器也负责将操作主分片到其他复制分片。

本章节的目的是对Elasticsearch复制模型进行高度概述，并讨论其对写入和读取操作之间的各种交互的影响。

# 基本写入模型

Elasticsearch中的每个索引操作首先使用[路由]()，通常基于文档ID解析为复制组位置。一旦确定了复制组位置，操作就会在内部转发到复制组的当前主分片。主分片负责验证操作并将其转发给其他副本。由于副本可以脱机，因此主服务器不需要复制到所有副本。相反，Elasticsearch维护应接收操作的分片副本列表。该列表被称为同步副本并由主节点维护。顾名思义，这是一组“好”的分片副本，保证已经处理了所有已经被用户确认的索引的建立和删除操作。主分片要负责维护数据一致，因此必须将所有操作复制到这个分片副本列表中的每个副本。

主分片遵循这个基本流程：

1. 验证传入的操作，并在结构无效的情况下拒绝它（例如：有一个对象字段，其中数字是预期的）
2. 在本地执行操作即索引或删除相关文档。这也将验证字段的内容，并在需要时拒绝（例如：在Lucene中索引的关键字值太长）。
3. 将操作转发到当前同步副本列表（in-sync list）中的每个副本。如果有多个副本，这是并行完成的。
4. 一旦所有副本都成功执行操作并响应主要操作，则主要确认向客户端成功完成请求。

## 失败处理

在建立索引期间很多事情可能会出错 --- 磁盘可能损坏，节点可能互相断开连接，或者某些配置错误可能导致副本上的操作失败，尽管在主节点上成功。这些并不常见，但主要是要对它们负责。

在主分片本身发生故障的情况下，托管主分片的节点将向主服务器（master节点）发送关于它的消息。索引操作将等待（[默认情况]()下最多1分钟），以便主服务器（master 节点）将其中一个副本提升为新的主分片。该操作将被转发到新的主分片进行处理。请注意，主服务器（master 节点）还监视所有节点的健康状况，并可能决定主动降级主分片。当存在网络问题将持有主分片的节点与群集隔离时，通常会发生前面主动降级情况。在[这里]()看到更多的细节。

在主分片上成功执行操作后，主分片在副本分片上执行操作时必须处理潜在的故障。 这可能是由副本上的实际故障或由于网络问题导致操作无法到达副本（或阻止副本响应）所致。 所有这些问题的最终结果都相同：复制分片作为同步副本集（in-sync list）一部分的副本未命中即将被确认的操作。 为了避免违反一致性，主分片发送一条消息给master主机，请求将有问题的分片从同步副本集中移除。 只有主服务器（master）确认移除有问题的分片后，主分片才确认操作。 请注意，主服务器（master）还将指示另一个节点开始构建新的分片副本，以便将系统恢复到健康状态。

在将操作转发到副本时，主分片将使用副本来验证它仍然是活动的主分片。如果主分片由于网络中断（或长GC）而被隔离，则可能会继续处理传入索引操作，然后才意识到其已降级。从老旧的主分片来的操作将被复制分片拒绝。因为它不再是主分片，它将会收到来自副本的拒绝请求的响应，，那么它将与主服务器联系，并且将知道它已被替换。然后被当作复制分片路由到新的主分片。

> ### 当没有分片时，会发生什么事情？
> 这是由于索引配置或仅因为所有副本都失败而可能发生的有效方案。在这种情况下，主分片会在没有任何外部验证条件下处理索引操作，这可能看起来有问题。另一方面，主分片不能自行破坏其他的分片请求，而是要求主节点代表它去处理。这意味着主服务（master节点）知道主分片(primary)是唯一的一个好的副本。因此，我们保证，主服务器不会将任何其他（过时的）分片副本推广为新的主分片，并且索引到主分片的任何操作都不会丢失。当然，从那时起，我们只运行单个数据副本，物理硬件问题可能会导致数据丢失。请参阅[等待活动分片]()编辑可以缓解选项。

# 基本读取模型
在Elasticsearch中读取可以通过ID进行非常轻量级的查找，也可以通过使用复杂聚合的沉重搜索请求来实现，而这些请求将占用不重要的CPU资源。主备份模式（primary-backup/master-salve）的一个优点是它保持所有分片副本一致（除正在执行操作外）。因此，单个同步副本足以满足读取请求。

当一个节点接收到读请求时，该节点负责将其转发到保存相关分片的节点，整理响应并响应客户端。我们称该节点为该请求的**协调节点**。基本流程如下：

1. 将读取请求解析到相关的分片。请注意，由于大多数搜索将被发送到一个或多个索引，它们通常需要从多个分片读取，每个分片代表不同的数据子集。
2. 从分片复制组中选择每个相关分片的活动副本。这可以是主分片的或复制分片。默认情况下，Elasticsearch只是在分片之间轮询（round robin）。
3. 发送分片级读取请求到选定的副本。
4. 合并结果并作出回应。请注意，在通过ID查找的情况下，只有一个分片是相关的，并且这个步骤可以被跳过。

### 失败处理

当分片无法响应读取请求时，协调节点将从同一个复制组中选择另一个副本，并将分片级别搜索请求发送到该副本。重复性故障可能导致没有分片副本可用。在某些情况下，比如**\_search**，Elasticsearch会倾向于快速响应，虽然只有部响应结果也作出了响应，而不是等待问题解决（部分结果\_shards会在响应头中明确指出）。

## 一些简单的含意

这些基本流程中的每一个都说明了Elasticsearch是一个读写系统。而且，由于读取和写入请求可以同时执行，这两个基本流程可以相互交互。这有一些内在的含义：

* 有效的读取  
在正常操作下，每个相关复制组执行一次读取操作。只有在失败情况下，同一个分片的多个副本才能执行相同的搜索。
* 阅读未确认   
由于分片首先在本地建立索引，然后给复制分片请求，所以并发读取可能在确认之前就已经看到了更改。
* 默认两份  
这个模型可以是容错的，同时只保留两个数据副本。这与基于法定人数的系统相反，其中容错的副本的最小数量是3。

# 失败
在失败的情况下，以下是可能的：

* 一个分片会减慢索引  
由于主分片在每个操作期间等待在同步副本中设置所有副本，因此一个慢分片可能会减慢整个复制组的速度。这是我们为上述读取效率付出的代价。当然，单个缓慢的分片也会减慢已经发送给它的搜索（route）。
* 脏读  
一个孤立的主分片可以暴露还没有被确认的写入。这是由于一个孤立的主分片只有在向副本发送请求或向主服务器（master）发送请求时才会被隔离。此时操作已经被索引到主数据库中，并可以通过并行读取来读取。Elasticsearch通过每秒（在默认情况下）对主服务器（master）进行ping操作，并在没有主服务器的情况下拒绝索引操作来减轻这种风险。

> ### Tips
> 本文档提供了Elasticsearch如何处理数据的高级概述。当然，还有很多事情要做。诸如terms，集群状态发布和主选举之类的事情都起着保持这个系统正常运转的作用。我们认识到在GitHub很难跟上已知和重要的错误（包括关闭和打开）。为了帮助人们保持最佳状态，我们在我们的网站上维护一个专门的弹性页面。我们强烈建议[阅读](https://www.elastic.co/guide/en/elasticsearch/resiliency/current/index.html)。