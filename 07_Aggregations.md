# 聚合操作

聚合框架帮助你在使用查询的时候进行数据的分析聚合。它建立在一个叫做聚合操作基础上，可以组合分析数据。

一个聚合操作可以看作是一组数据的整理分析的工作单元。执行的上下文定义了该文档所设置的内容（例如，顶级聚合在执行的查询/搜索请求的过滤器的上下文内执行）。

聚合操作有许多不同的型，每一个都拥有它自己的目的和输出。为了更加容易地了解它们的类型，可以将它们划分为4大类型：

[_归类（桶） Bucketing_](search-aggregations-bucket.html)

    构建归类的一系列聚合，其中每个类别都与_key_和文档条件相关联。在执行汇总时，所有的时段标准都会在上下文中的每个文档上进行评估，当标准匹配，文档被认为是“落入”相关的分类。 在聚合过程结束之前，我们将得到一个分类列表 - 每个分类都有一组“属于”的文档。

[_度量 Metric_](search-aggregations-metrics.html)

     通过一组文档跟踪和计算度量标准的聚合。
[_矩阵 Matrix_](search-aggregations-matrix.html)

    一组聚合操作在多个字段上，并基于从请求的文档字段中提取的值生成矩阵结果。 与度量和存储桶聚合不同，此聚合系列还不支持脚本。
    
[_管道传送 Pipeline_](search-aggregations-pipeline.html)
     
    聚合其他聚合的输出及其相关度量的聚合 

接下来是有趣的部分。由于每个分类有效地定义了一个文档集（属于分类的所有文档），因此可能会将存分类级别的聚合关联起来，这些存储将在该存储区的上下文内执行。 这是聚合的真正力量：**聚合可以嵌套！**

![Note](/images/icons/note.png)

分类聚合可以拥有子聚合操作（分类聚合或度量聚合),将针对其父聚合生成的分类聚合计算的子集合。 嵌套聚合的级别/深度没有硬性限制（可以在“父级”聚合下嵌套聚合，这本身就是一个子聚合

## 聚合操作结构

下面是一个最基本的聚合操作的结构：    
    
    "aggregations" : {
        "<aggregation_name>" : {
            "<aggregation_type>" : {
                <aggregation_body>
            }
            [,"meta" : {  [<meta_data_body>] } ]?
            [,"aggregations" : { [<sub_aggregation>]+ } ]?
        }
        [,"<aggregation_name_2>" : { ... } ]*
    }

`aggregations` 对象 (可以使用`aggs`进行使用) 在JSON文档中定义了聚合操作的定义.每一个聚合操作都有一个用户定义的逻辑名称。 (例如. 如果要计算价格，可以将逻辑名称定义为`avg_price`).在响应中逻辑名称是聚合操作的唯一的标识，每个聚合都有一个特定的类型（上面代码片段中的<aggregation_type>），通常是指定聚合体中的第一个键。每种类型的聚合定义了它自己的身体，这取决于聚合的性质（例如，在特定字段上的`avg`聚合将定义计算平均值的字段）。在聚合类型定义的同一级别，可以选择定义一组额外的聚合，尽管这只有在您定义的聚合具有分组性质时才有意义。在这种情况下，将在分类聚合级别上定义的子聚合将针对分类聚合构建的所有分区进行计算。 例如，如果您在“range”聚合下定义了一组汇总，则将针对定义的范围分类聚合计算子汇总。


### 操作的值来源
某些聚合操作是在聚合操作生成的文档上进行处理的。通常，这些值将从聚合生成文档的`feild`键设置的特定文档字段中提取。 还可以定义一个[`script`](modules-scripting.html)，用来生成值（每个文档）。当为聚合操作配置“field”和“script”设置时，`script`将被视为`value script`。虽然正常脚本是在文档级别上进行操作的（即脚本可以访问与文档相关的所有数据），但`value script`是在**值**级别上操作的。在这种模式下，值从聚合操作生成的的`field`中提取，`script`用于对这些值进行“变换”。


![Note](/images/icons/note.png)

使用脚本时，也可以定义`lang`和`params`设置。 前者定义了使用的脚本语言（假定Elasticsearch中有适当的语言，默认或插件）。后者可以将脚本中的所有“动态”表达式定义为参数，从而使脚本在调用之间保持静态（这将确保在Elasticsearch中使用缓存的编译脚本）。

ES使用映射中字段的类型来计算如何运行聚合和格式化响应。然而，有两种情况Elasticsearch无法找出这些信息：未映射的字段（例如在跨多个索引的搜索请求的情况下，只有一些字段具有映射）和纯脚本。 对于这些情况，可以使用`value_type`选项给Elasticsearch一个提示，它接受下列值：`string`，`long`（适用于所有整数类型），`double`（适用于所有小数类型 `float`或`scaled_float`），`date`，`ip`和`boolean`。
